# ğŸš€ v4.3.1 â€“ SoM-Centric Pipeline with Extended Metrics & Dissertation Final

**Release date:** 2025-12-11
**Branch:** `main`
**Pipeline version:** v4.3.1
**Snapshot:** P000001/2025-12-09
**Author:** Rodrigo Marques Teixeira
**Project:** MSc AI for Business â€“ Practicum Part 2 (N-of-1 ADHD + BD)

---

## ğŸ“Š Summary

This release introduces the **SoM-centric ML pipeline** with PhD-level evaluation metrics, naÃ¯ve baselines comparison, and finalized dissertation figures. The pipeline now targets **State-of-Mind (SoM) labels** from ecological momentary assessment (EMA) rather than PBSI-derived labels, providing clinical validation alignment.

**Key improvements:**

- âœ… SoM-centric target variables (77 labeled days from EMA diary)
- âœ… PhD-level metrics module (`ml_metrics_extended.py`)
- âœ… NaÃ¯ve baselines: majority-class, stratified-random, persistence
- âœ… Per-class metrics with confusion matrix aggregation
- âœ… Extended HRV features (SDNN mean/median/min/max)
- âœ… Medication features integration (med_any, med_event_count, med_dose_total)
- âœ… 13 dissertation figures regenerated with improved visualizations

---

## ğŸ“ˆ Performance Results

### ML6-Extended (Tabular Models)

**Best model: XGBoost** on binary SoM classification:

| Model              | F1-Macro        | Balanced Acc    | Cohen Îº         |
| ------------------ | --------------- | --------------- | --------------- |
| **XGBoost**        | **0.63 Â± 0.19** | **0.63 Â± 0.19** | **0.27 Â± 0.37** |
| GradientBoosting   | 0.57 Â± 0.14     | 0.65 Â± 0.21     | 0.18 Â± 0.27     |
| LogisticRegression | 0.47 Â± 0.17     | 0.57 Â± 0.19     | 0.08 Â± 0.26     |
| RandomForest       | 0.46 Â± 0.02     | 0.50 Â± 0.00     | 0.00 Â± 0.00     |

**Baseline comparison (XGBoost vs naÃ¯ve):**

| Method            | F1-Macro | Balanced Acc | Cohen Îº  |
| ----------------- | -------- | ------------ | -------- |
| **XGBoost**       | **0.63** | **0.63**     | **0.27** |
| Persistence       | 0.53     | 0.53         | 0.06     |
| Stratified Random | 0.46     | 0.46         | -0.05    |
| Majority Class    | 0.46     | 0.50         | 0.00     |

### ML7-Extended (Sequence Models)

**Best models:** LSTM and CNN-LSTM on 14-day sequences:

| Model        | F1-Macro        | Balanced Acc    | Cohen Îº         |
| ------------ | --------------- | --------------- | --------------- |
| **CNN_LSTM** | **0.53 Â± 0.16** | **0.63 Â± 0.18** | **0.16 Â± 0.26** |
| **LSTM**     | **0.52 Â± 0.23** | **0.65 Â± 0.23** | N/A             |
| Conv1D       | 0.44 Â± 0.03     | 0.54 Â± 0.12     | -0.02 Â± 0.04    |
| GRU          | 0.43 Â± 0.22     | 0.57 Â± 0.19     | 0.07 Â± 0.29     |

---

## ğŸ” Dataset Configuration

- **Total days (full timeline):** 2,868 (2017-12-04 to 2025-12-08)
- **SoM-labeled days:** 77 (from EMA diary)
- **ML7 sequences:** 60 (14-day windows from 77 days)
- **Label distribution (binary):** 66 typical (86%) / 11 regulated (14%)
- **Features:** 19 (FS-D: sleep, cardio, HRV, activity, medication, PBSI)
- **Missing data:** 0 (post-MICE imputation with global median fallback)

---

## ğŸ†• New Features

### PhD-Level Metrics Module

New `src/etl/ml_metrics_extended.py` provides:

1. **NaÃ¯ve Baselines:**

   - Majority-class (always predict most frequent)
   - Stratified-random (sample from training distribution)
   - Persistence (predict yesterday's label)

2. **Per-Class Metrics:**

   - Precision, Recall, F1 per class
   - Support counts across folds
   - Aggregated confusion matrices (sum/mean)

3. **Export Structure:**
   ```
   results/metrics/P000001/2025-12-09/
   â”œâ”€â”€ baseline_comparisons/
   â”‚   â”œâ”€â”€ baseline_comparison_binary.csv
   â”‚   â””â”€â”€ baseline_comparison_seq_som_binary.csv
   â”œâ”€â”€ confusion_matrices/
   â”‚   â”œâ”€â”€ cm_XGBoost_binary.json
   â”‚   â”œâ”€â”€ cm_CNN_LSTM_seq_som_binary.json
   â”‚   â””â”€â”€ cm_GRU_seq_som_binary.json
   â””â”€â”€ per_class/
       â”œâ”€â”€ per_class_XGBoost_binary.csv
       â””â”€â”€ per_class_CNN_LSTM_seq_som_binary.csv
   ```

### Improved Dissertation Figures

All 13 figures regenerated with:

- **fig04:** Segment-wise normalization with 5 representative segments (HR quantiles)
- **fig08:** Temporal drift analysis (per-fold performance across models)
- **fig09:** SHAP feature importance from GradientBoosting (Top-10)
- **fig10-13:** Extended models comparison with random baseline reference

---

## âš™ï¸ Pipeline Improvements

### MICE Imputation Fix

- Handle all-NaN columns gracefully (skip in IterativeImputer)
- Global median fallback for remaining NaN values after segment-wise MICE
- Prevents `ValueError` from sklearn with constant columns

### PBSI Segment Handling

- Preserve existing `segment_id` from temporal segmentation
- Avoid overwriting with 'global' when segments already exist
- Consistent z-score normalization per segment

---

## ğŸ”§ Quick Start

```bash
# Clone repository
git clone https://github.com/rodrigomarquest/practicum2-nof1-adhd-bd.git
cd practicum2-nof1-adhd-bd

# Setup environment (Python 3.11+)
python -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate
pip install -r requirements/local.txt

# Run full pipeline (stages 0-9)
python scripts/run_full_pipeline.py \
  --participant P000001 \
  --snapshot 2025-12-09 \
  --start-stage 3 \
  --end-stage 9

# Generate dissertation figures
python scripts/generate_dissertation_figures.py
```

---

## ğŸ“„ Documentation

- `docs/ETL_ARCHITECTURE_COMPLETE.md` â€“ Full pipeline architecture
- `docs/PHASE3_ENRICHED_GLOBAL_ARCHITECTURE.md` â€“ Enriched features design
- `docs/QUICK_REFERENCE_ETL.md` â€“ ETL quick reference guide

---

## ğŸ“ Changed Files

### New Files

- `src/etl/ml_metrics_extended.py` â€“ PhD-level evaluation metrics
- `results/metrics/P000001/2025-12-09/*` â€“ Exported metrics (CSV/JSON)

### Modified Files

- `src/etl/ml6_extended.py` â€“ Extended metrics integration
- `src/etl/ml7_extended.py` â€“ Extended metrics integration
- `scripts/generate_dissertation_figures.py` â€“ Updated to snapshot 2025-12-09
- `scripts/run_full_pipeline.py` â€“ MICE imputation fix
- `src/labels/build_pbsi.py` â€“ Segment handling fix
- `notebooks/generate_dissertation_figures.ipynb` â€“ Updated paths

---

## ğŸ§¾ Citation

Teixeira, R. M. (2025). _A Deterministic N-of-1 Pipeline for Multimodal Digital Phenotyping in ADHD and Bipolar Disorder._
MSc Dissertation, National College of Ireland.
GitHub: https://github.com/rodrigomarquest/practicum2-nof1-adhd-bd

---

âš–ï¸ **License:** CC BY-NC-SA 4.0
**Supervisor:** Dr. Agatha Mattos
**Student ID:** 24130664
